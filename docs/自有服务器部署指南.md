# 自有服务器部署指南（可执行版）

本项目已提供自动化脚本，按下面顺序即可部署到你自己的 Linux 服务器。

## 1. 准备
- 一台 Ubuntu 22.04/24.04 服务器（建议 2C4G）
- 域名已解析到服务器公网IP
- PostgreSQL 连接串（保持当前 PostgreSQL 不变）

## 2. 填配置
复制文件：
```bash
cp ops/server/.deploy.env.example ops/server/.deploy.env
```

编辑 `ops/server/.deploy.env`，至少填写：
- `DOMAIN`
- `LETSENCRYPT_EMAIL`
- `NEXT_PUBLIC_APP_URL`
- `DATABASE_URL`
- `DIRECT_DATABASE_URL`
- `MANAGER_EMAILS`
- `OWNER_MANAGER_EMAIL`
- `CRON_SECRET`

## 3. 上传到服务器（Windows）
在本地 PowerShell 执行：
```powershell
powershell -ExecutionPolicy Bypass -File ops/server/run_remote.ps1 -Host <服务器IP> -User <登录用户> -KeyPath <私钥路径>
```

## 4. 在服务器执行（按顺序）
```bash
sudo bash ~/tuition-scheduler/ops/server/scripts/bootstrap_server.sh ~/tuition-scheduler/ops/server/.deploy.env
sudo -u deploy bash ~/tuition-scheduler/ops/server/scripts/deploy_app.sh ~/tuition-scheduler/ops/server/.deploy.env
sudo bash ~/tuition-scheduler/ops/server/scripts/configure_nginx.sh ~/tuition-scheduler/ops/server/.deploy.env
sudo bash ~/tuition-scheduler/ops/server/scripts/setup_ssl.sh ~/tuition-scheduler/ops/server/.deploy.env
sudo bash ~/tuition-scheduler/ops/server/scripts/setup_backup_cron.sh ~/tuition-scheduler/ops/server/.deploy.env
```

## 5. 验收
- 打开 `https://你的域名/admin/login`
- 管理端和老师端均可登录
- 抽测导出 PDF（学生课表、报名、课包、老师名片）

## 6. 后续发布
```bash
sudo -u deploy bash ~/tuition-scheduler/ops/server/scripts/deploy_app.sh ~/tuition-scheduler/ops/server/.deploy.env
```

## 7. 备份说明
- 脚本：`ops/server/scripts/backup_postgres.sh`
- 默认每天 `03:00` 自动备份，保留 7 天。
- 日志：`/var/log/<APP_NAME>_backup.log`

## 8. 文件清单
- `ops/server/.deploy.env.example`
- `ops/server/run_remote.ps1`
- `ops/server/scripts/bootstrap_server.sh`
- `ops/server/scripts/deploy_app.sh`
- `ops/server/scripts/configure_nginx.sh`
- `ops/server/scripts/setup_ssl.sh`
- `ops/server/scripts/backup_postgres.sh`
- `ops/server/scripts/setup_backup_cron.sh`
- `ops/server/templates/nginx.tuition-scheduler.conf`
