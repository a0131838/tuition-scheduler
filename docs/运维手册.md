# 运维手册（自有服务器）

本文面向日常运维：一键部署、健康检查、日志排查、数据库备份与常见故障处理。

## 0. 约定

- 服务器上项目目录：`/home/ubuntu/apps/tuition-scheduler`（以你的当前部署为准）
- 运行用户：`ubuntu`
- 进程管理：`pm2`
- 反代：`nginx`
- 数据库：PostgreSQL（本机 `localhost:5432`）
- 域名：`https://sgtmanage.com`

## 1. 一键部署（推荐）

在服务器执行：

```bash
tuition-deploy
```

它会执行：

- `git pull`
- `npm ci`
- `prisma migrate deploy`
- `npm run build`
- `pm2 restart`
- 关键页面健康检查（允许 200/3xx）

## 2. 只做健康检查

```bash
tuition-check
```

## 3. 看日志（排错最快）

```bash
tuition-logs
```

只看错误日志：

```bash
tail -n 200 ~/.pm2/logs/tuition-scheduler-error.log
```

## 4. 常见故障与处理

### 4.1 页面白屏，提示 Digest / Application error

1. 先看 `~/.pm2/logs/tuition-scheduler-error.log`
2. 如果是 Prisma 报错：
   - `column does not exist` / `relation does not exist`：通常是数据库没跑迁移或迁移缺失
   - 处理：`tuition-deploy`（它会跑 `prisma migrate deploy`）

### 4.2 80 正常但 443 超时

- 检查云厂商防火墙（轻量云/安全组）是否放行 `443/TCP`
- 检查 Nginx：
  - `sudo nginx -t`
  - `sudo systemctl status nginx`

### 4.3 登录循环跳转 / 管理端布局不显示

- 先用无痕窗口排除 Cookie 影响
- 如果仍然异常：执行 `tuition-deploy`，并看 error log

## 5. 数据库备份

手工备份（会生成 gzip 文件）：

```bash
bash /home/ubuntu/apps/tuition-scheduler/ops/server/scripts/backup_postgres.sh
```

启用每天定时备份（可选）：

```bash
sudo bash /home/ubuntu/apps/tuition-scheduler/ops/server/scripts/setup_backup_cron.sh
```

