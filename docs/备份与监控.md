# 备份与监控（生产维护）

目标：
- 数据安全：可恢复、可验证、可演练
- 低运维：自动化、少人工、出问题能快速定位

当前架构（以你现网为准）：
- 应用：自建服务器 + Vercel（可选）
- 数据库：Neon PostgreSQL（建议作为唯一真实数据源）

## 1. 数据库备份（本地）

备份脚本会生成一个 `pg_dump -Fc` 的 `.dump` 文件（适合用 `pg_restore` 恢复）：

```bash
bash /home/ubuntu/apps/tuition-scheduler/ops/server/scripts/backup_postgres.sh /home/ubuntu/apps/tuition-scheduler/ops/server/.deploy.env
```

默认备份目录：
- `/home/ubuntu/backups/tuition-scheduler`

默认保留：
- 7 天（可通过 `RETENTION_DAYS` 覆盖）

## 2. 备份到对象存储（COS/S3 兼容）

说明：
- 备份和迁移建议使用 `DIRECT_DATABASE_URL`（Neon 直连、非 pooler）。
- 对象存储密钥不要放在 `ops/server/.deploy.env`（避免进入应用运行时 `.env`）。

### 2.1 配置对象存储密钥（服务器上）

```bash
sudo mkdir -p /etc/tuition-scheduler
sudo chmod 755 /etc/tuition-scheduler
sudo tee /etc/tuition-scheduler/backup.env >/dev/null <<'EOF'
# S3-compatible object storage (Tencent COS / AWS S3 / others)
S3_BUCKET=
S3_PREFIX=tuition-scheduler/backups
AWS_ACCESS_KEY_ID=
AWS_SECRET_ACCESS_KEY=
AWS_DEFAULT_REGION=ap-hongkong
# Optional, e.g. Tencent COS: https://cos.ap-hongkong.myqcloud.com
S3_ENDPOINT_URL=
EOF
sudo chmod 600 /etc/tuition-scheduler/backup.env

# 重要：这些脚本默认通过当前用户的 crontab 运行（通常是 ubuntu），
# /etc 下的 env 文件需要让该用户可读，否则会出现 Permission denied。
sudo chown ubuntu:ubuntu /etc/tuition-scheduler/backup.env
```

安装 AWS CLI（如果没有）：

```bash
sudo apt-get update && sudo apt-get install -y awscli
```

### 2.2 手工执行一次备份并上传

```bash
bash /home/ubuntu/apps/tuition-scheduler/ops/server/scripts/backup_postgres_to_object_storage.sh /home/ubuntu/apps/tuition-scheduler/ops/server/.deploy.env
```

### 2.3 开启每天定时备份并上传

```bash
bash /home/ubuntu/apps/tuition-scheduler/ops/server/scripts/setup_backup_object_storage_cron.sh /home/ubuntu/apps/tuition-scheduler/ops/server/.deploy.env
```

## 3. 最小监控（HTTP + 告警）

### 3.1 配置监控告警（可选）

```bash
sudo mkdir -p /etc/tuition-scheduler
sudo chmod 755 /etc/tuition-scheduler
sudo tee /etc/tuition-scheduler/monitor.env >/dev/null <<'EOF'
# Space-separated URLs
# MONITOR_URLS="https://sgtmanage.com/ https://sgtmanage.com/admin/login"
MONITOR_URLS=

# Optional: webhook receiver (your own service / Slack-compatible / etc.)
ALERT_WEBHOOK_URL=

# Optional: email (requires `mail` to be installed and configured)
ALERT_EMAIL_TO=
ALERT_FROM=
EOF
sudo chmod 600 /etc/tuition-scheduler/monitor.env

# 同上：让跑 cron 的用户可读。
sudo chown ubuntu:ubuntu /etc/tuition-scheduler/monitor.env
```

### 3.2 启用每 5 分钟监控一次

```bash
bash /home/ubuntu/apps/tuition-scheduler/ops/server/scripts/setup_monitor_cron.sh /home/ubuntu/apps/tuition-scheduler/ops/server/.deploy.env
```

## 4. 建议的运维纪律

建议你长期按这个规则维护：
- 数据库 schema 变更只用 Prisma migration，不要手改库结构。
- 发布流程：先 Vercel Preview 验收，再合并上生产并 `tuition-deploy`。
- 每次改动后至少做一次“恢复演练”：用备份恢复到一个新库，确认能正常启动并能登录。
