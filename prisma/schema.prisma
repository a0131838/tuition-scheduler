generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

enum UserRole {
  ADMIN
  TEACHER
  STUDENT
}

enum UserLanguage {
  BILINGUAL
  ZH
  EN
}

enum PackageType {
  HOURS // 课时包（按分钟扣）
  MONTHLY // 月卡（有效期内不扣分钟）
}

enum PackageStatus {
  ACTIVE
  PAUSED
  EXPIRED
}

enum AttendanceStatus {
  UNMARKED
  PRESENT
  ABSENT
  LATE
  EXCUSED
}

enum AppointmentMode {
  ONLINE
  OFFLINE
}

enum TeachingLanguage {
  CHINESE
  ENGLISH
  BILINGUAL
}

enum BookingRequestStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum FeedbackStatus {
  ON_TIME
  LATE
  PROXY_DRAFT
}

enum PartnerSettlementMode {
  ONLINE_PACKAGE_END
  OFFLINE_MONTHLY
}

enum PartnerSettlementStatus {
  PENDING
  INVOICED
  CANCELLED
}

model Campus {
  id             String          @id @default(uuid())
  name           String
  isOnline       Boolean         @default(false)
  rooms          Room[]
  classes        Class[]
  oneOnOneGroups OneOnOneGroup[]
}

model Room {
  id       String @id @default(uuid())
  name     String
  capacity Int

  campusId String
  campus   Campus @relation(fields: [campusId], references: [id])

  classes        Class[]
  oneOnOneGroups OneOnOneGroup[]
}

model Teacher {
  id   String @id @default(uuid())
  name String

  nationality           String?
  almaMater             String?
  intro                 String?
  yearsExperience       Int?
  teachingLanguage      TeachingLanguage?
  teachingLanguageOther String?
  offlineShanghai       Boolean           @default(false)
  offlineSingapore      Boolean           @default(false)

  subjectCourseId String?
  subjectCourse   Subject?  @relation("SubjectCourse", fields: [subjectCourseId], references: [id])
  subjects        Subject[] @relation("TeacherSubjects")

  availabilities            TeacherAvailability[]
  dateAvailabilities        TeacherAvailabilityDate[]
  oneOnOneTemplates         TeacherOneOnOneTemplate[]        @relation("TeacherOneOnOneTemplateTeacher")
  oneOnOneGroups            OneOnOneGroup[]
  classes                   Class[]
  appointments              Appointment[]
  sessionOverrides          Session[]                        @relation("SessionTeacherOverride")
  sessionFeedbacks          SessionFeedback[]
  sessionTeacherChangesFrom SessionTeacherChange[]           @relation("SessionTeacherChangeFrom")
  sessionTeacherChangesTo   SessionTeacherChange[]           @relation("SessionTeacherChangeTo")
  users                     User[]
  bookingLinks              StudentBookingLinkTeacher[]
  bookingRequests           StudentBookingRequest[]
  selectedBookingSlots      StudentBookingLinkSelectedSlot[]
  bookingRequestSlotLocks   StudentBookingRequestSlotLock[]
  courseRates               TeacherCourseRate[]
}

model TeacherCourseRate {
  id              String   @id @default(uuid())
  teacherId       String
  courseId        String
  subjectId       String?
  levelId         String?
  subjectKey      String   @default("")
  levelKey        String   @default("")
  hourlyRateCents Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  teacher Teacher  @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  course  Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  subject Subject? @relation(fields: [subjectId], references: [id], onDelete: SetNull)
  level   Level?   @relation(fields: [levelId], references: [id], onDelete: SetNull)

  @@unique([teacherId, courseId, subjectKey, levelKey])
  @@index([teacherId, updatedAt])
}

model OneOnOneGroup {
  id        String   @id @default(uuid())
  teacherId String
  courseId  String
  subjectId String?
  levelId   String?
  campusId  String
  roomId    String?
  createdAt DateTime @default(now())

  teacher Teacher  @relation(fields: [teacherId], references: [id])
  course  Course   @relation(fields: [courseId], references: [id])
  subject Subject? @relation(fields: [subjectId], references: [id])
  level   Level?   @relation(fields: [levelId], references: [id])
  campus  Campus   @relation(fields: [campusId], references: [id])
  room    Room?    @relation(fields: [roomId], references: [id])

  classes Class[]

  @@index([teacherId])
  @@index([courseId])
  @@index([campusId])
}

model TeacherAvailability {
  id        String @id @default(uuid())
  teacherId String
  weekday   Int // 0-6 (Sun-Sat)
  startMin  Int // minutes from 00:00
  endMin    Int

  teacher Teacher @relation(fields: [teacherId], references: [id])
}

model TeacherAvailabilityDate {
  id        String   @id @default(uuid())
  teacherId String
  date      DateTime // date-only (local), time in startMin/endMin
  startMin  Int // minutes from 00:00
  endMin    Int

  teacher Teacher @relation(fields: [teacherId], references: [id])

  @@index([teacherId, date])
}

model TeacherOneOnOneTemplate {
  id          String   @id @default(uuid())
  teacherId   String
  studentId   String
  classId     String
  weekday     Int // 0-6 (Sun-Sat)
  startMin    Int // minutes from 00:00
  durationMin Int
  createdAt   DateTime @default(now())

  teacher Teacher @relation("TeacherOneOnOneTemplateTeacher", fields: [teacherId], references: [id])
  student Student @relation("TeacherOneOnOneTemplateStudent", fields: [studentId], references: [id])
  class   Class   @relation("TeacherOneOnOneTemplateClass", fields: [classId], references: [id])

  @@index([teacherId])
  @@index([studentId])
}

model Course {
  id   String @id @default(uuid())
  name String

  subjects       Subject[]
  classes        Class[]
  packages       CoursePackage[]
  oneOnOneGroups OneOnOneGroup[]
  teacherRates   TeacherCourseRate[]
}

model Subject {
  id       String @id @default(uuid())
  name     String
  courseId String

  course         Course          @relation(fields: [courseId], references: [id])
  levels         Level[]
  classes        Class[]
  oneOnOneGroups OneOnOneGroup[]
  teacherRates   TeacherCourseRate[]

  subjectTeachers      Teacher[] @relation("SubjectCourse")
  subjectTeachersMulti Teacher[] @relation("TeacherSubjects")

  @@unique([courseId, name])
  @@index([courseId])
}

model Level {
  id        String @id @default(uuid())
  name      String
  subjectId String

  subject        Subject         @relation(fields: [subjectId], references: [id])
  classes        Class[]
  oneOnOneGroups OneOnOneGroup[]
  teacherRates   TeacherCourseRate[]

  @@unique([subjectId, name])
  @@index([subjectId])
}

model Class {
  id String @id @default(uuid())

  courseId  String
  subjectId String?
  levelId   String?
  teacherId String
  campusId  String
  roomId    String?

  capacity          Int
  oneOnOneGroupId   String?
  oneOnOneStudentId String?

  course          Course         @relation(fields: [courseId], references: [id])
  subject         Subject?       @relation(fields: [subjectId], references: [id])
  level           Level?         @relation(fields: [levelId], references: [id])
  teacher         Teacher        @relation(fields: [teacherId], references: [id])
  campus          Campus         @relation(fields: [campusId], references: [id])
  room            Room?          @relation(fields: [roomId], references: [id])
  oneOnOneGroup   OneOnOneGroup? @relation(fields: [oneOnOneGroupId], references: [id])
  oneOnOneStudent Student?       @relation("OneOnOneStudentClass", fields: [oneOnOneStudentId], references: [id])

  sessions          Session[]
  enrollments       Enrollment[]
  oneOnOneTemplates TeacherOneOnOneTemplate[] @relation("TeacherOneOnOneTemplateClass")

  @@index([subjectId])
  @@index([levelId])
  @@index([oneOnOneGroupId])
  @@index([oneOnOneStudentId])
}

model Session {
  id        String   @id @default(uuid())
  classId   String
  startAt   DateTime
  endAt     DateTime
  teacherId String?
  studentId String?

  class           Class                   @relation(fields: [classId], references: [id])
  teacher         Teacher?                @relation("SessionTeacherOverride", fields: [teacherId], references: [id])
  student         Student?                @relation("SessionStudent", fields: [studentId], references: [id])
  attendances     Attendance[]
  feedbacks       SessionFeedback[]
  teacherChanges  SessionTeacherChange[]
  bookingRequests StudentBookingRequest[]
  signInAlerts    SignInAlert[]

  @@index([studentId])
  @@index([classId, startAt])
  @@index([teacherId, startAt])
  @@index([startAt])
  @@index([startAt, endAt])
}

model AppSetting {
  key       String   @id
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SignInAlert {
  id               String    @id @default(uuid())
  sessionId        String
  alertType        String
  targetRole       String
  targetUserId     String?
  studentId        String?
  scopeKey         String
  thresholdMin     Int
  firstTriggeredAt DateTime  @default(now())
  lastTriggeredAt  DateTime  @default(now())
  resolvedAt       DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([sessionId, alertType, targetRole, scopeKey])
  @@index([targetRole, targetUserId, resolvedAt, lastTriggeredAt])
  @@index([sessionId, resolvedAt])
}

model SessionFeedback {
  id                   String         @id @default(uuid())
  sessionId            String
  teacherId            String
  content              String
  focusStudentName     String?
  actualStartAt        DateTime?
  actualEndAt          DateTime?
  classPerformance     String?
  homework             String?
  previousHomeworkDone Boolean?
  forwardedAt          DateTime?
  forwardedBy          String?
  forwardChannel       String?
  forwardNote          String?
  status               FeedbackStatus @default(ON_TIME)
  dueAt                DateTime?
  submittedByRole      String?
  submittedByUserId    String?
  isProxyDraft         Boolean        @default(false)
  proxyNote            String?
  submittedAt          DateTime       @default(now())
  updatedAt            DateTime       @updatedAt

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  teacher Teacher @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@unique([sessionId, teacherId])
  @@index([teacherId, submittedAt])
  @@index([status, dueAt])
}

model SessionTeacherChange {
  id            String   @id @default(uuid())
  sessionId     String
  fromTeacherId String
  toTeacherId   String
  reason        String?
  changedBy     String?
  changedAt     DateTime @default(now())

  session     Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  fromTeacher Teacher @relation("SessionTeacherChangeFrom", fields: [fromTeacherId], references: [id])
  toTeacher   Teacher @relation("SessionTeacherChangeTo", fields: [toTeacherId], references: [id])

  @@index([sessionId])
}

model Student {
  id              String    @id @default(uuid())
  name            String
  school          String?
  birthDate       DateTime?
  grade           String?
  targetSchool    String?
  currentMajor    String?
  coachingContent String?
  note            String?
  sourceChannelId String?
  studentTypeId   String?
  settlementMode  PartnerSettlementMode?

  enrollments        Enrollment[]
  appointments       Appointment[]
  packages           CoursePackage[]
  sharedPackageLinks CoursePackageSharedStudent[]
  attendances        Attendance[]
  oneOnOneTemplates  TeacherOneOnOneTemplate[]    @relation("TeacherOneOnOneTemplateStudent")
  oneOnOneClasses    Class[]                      @relation("OneOnOneStudentClass")
  sessions           Session[]                    @relation("SessionStudent")
  sourceChannel      StudentSourceChannel?        @relation(fields: [sourceChannelId], references: [id])
  studentType        StudentType?                 @relation(fields: [studentTypeId], references: [id])
  bookingLinks       StudentBookingLink[]
  bookingRequests    StudentBookingRequest[]
  settlements        PartnerSettlement[]

  @@index([sourceChannelId])
  @@index([studentTypeId])
}

model PartnerSettlement {
  id         String                  @id @default(uuid())
  studentId  String
  packageId  String?
  monthKey   String?
  mode       PartnerSettlementMode
  status     PartnerSettlementStatus @default(PENDING)
  hours      Decimal                 @default(0) @db.Decimal(10, 2)
  amount     Int                     @default(0)
  note       String?
  createdAt  DateTime                @default(now())
  updatedAt  DateTime                @updatedAt

  student Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)
  package CoursePackage? @relation(fields: [packageId], references: [id], onDelete: SetNull)

  @@unique([packageId, mode])
  @@unique([studentId, monthKey, mode])
  @@index([mode, status, createdAt])
  @@index([studentId, createdAt])
}

model StudentSourceChannel {
  id        String   @id @default(uuid())
  name      String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  students Student[]

  @@unique([name])
}

model StudentType {
  id        String   @id @default(uuid())
  name      String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  students Student[]

  @@unique([name])
}

model User {
  id           String       @id @default(uuid())
  email        String       @unique
  name         String
  role         UserRole     @default(ADMIN)
  language     UserLanguage @default(BILINGUAL)
  teacherId    String?      @unique
  passwordHash String
  passwordSalt String
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  teacher  Teacher?      @relation(fields: [teacherId], references: [id], onDelete: SetNull)
  sessions AuthSession[]
}

model ManagerAcl {
  id        String   @id @default(uuid())
  email     String   @unique
  isActive  Boolean  @default(true)
  note      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AuthSession {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model Enrollment {
  id        String @id @default(uuid())
  classId   String
  studentId String

  class   Class   @relation(fields: [classId], references: [id])
  student Student @relation(fields: [studentId], references: [id])

  @@unique([classId, studentId])
}

model Appointment {
  id        String          @id @default(uuid())
  teacherId String
  studentId String
  startAt   DateTime
  endAt     DateTime
  mode      AppointmentMode

  teacher         Teacher                 @relation(fields: [teacherId], references: [id])
  student         Student                 @relation(fields: [studentId], references: [id])
  bookingRequests StudentBookingRequest[]

  @@index([teacherId, startAt])
  @@index([studentId, startAt])
  @@index([startAt])
}

model StudentBookingLink {
  id                String    @id @default(uuid())
  token             String    @unique
  studentId         String
  title             String?
  note              String?
  startDate         DateTime
  endDate           DateTime
  durationMin       Int       @default(60)
  slotStepMin       Int       @default(15)
  onlySelectedSlots Boolean   @default(false)
  isActive          Boolean   @default(true)
  expiresAt         DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  student       Student                          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  teachers      StudentBookingLinkTeacher[]
  selectedSlots StudentBookingLinkSelectedSlot[]
  requests      StudentBookingRequest[]

  @@index([studentId, createdAt])
  @@index([token, isActive])
}

model StudentBookingLinkSelectedSlot {
  id        String   @id @default(uuid())
  linkId    String
  teacherId String
  startAt   DateTime
  endAt     DateTime
  createdAt DateTime @default(now())

  link    StudentBookingLink @relation(fields: [linkId], references: [id], onDelete: Cascade)
  teacher Teacher            @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@unique([linkId, teacherId, startAt, endAt])
  @@index([linkId, startAt])
  @@index([teacherId, startAt])
}

model StudentBookingLinkTeacher {
  id        String   @id @default(uuid())
  linkId    String
  teacherId String
  createdAt DateTime @default(now())

  link    StudentBookingLink @relation(fields: [linkId], references: [id], onDelete: Cascade)
  teacher Teacher            @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@unique([linkId, teacherId])
  @@index([teacherId])
}

model TodoReminderConfirm {
  id        String   @id @default(uuid())
  type      String
  targetId  String
  date      DateTime
  createdAt DateTime @default(now())

  @@unique([type, targetId, date])
  @@index([type, date])
  @@index([targetId, date])
}

model StudentBookingRequest {
  id            String               @id @default(uuid())
  linkId        String
  studentId     String
  teacherId     String
  startAt       DateTime
  endAt         DateTime
  coursePref    String?
  note          String?
  status        BookingRequestStatus @default(PENDING)
  reviewedAt    DateTime?
  reviewedBy    String?
  adminNote     String?
  appointmentId String?
  sessionId     String?
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt

  link        StudentBookingLink             @relation(fields: [linkId], references: [id], onDelete: Cascade)
  student     Student                        @relation(fields: [studentId], references: [id], onDelete: Cascade)
  teacher     Teacher                        @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  appointment Appointment?                   @relation(fields: [appointmentId], references: [id], onDelete: SetNull)
  session     Session?                       @relation(fields: [sessionId], references: [id], onDelete: SetNull)
  slotLock    StudentBookingRequestSlotLock?

  @@index([linkId, status, createdAt])
  @@index([teacherId, startAt])
  @@index([studentId, startAt])
  @@index([sessionId])
}

model StudentBookingRequestSlotLock {
  id        String   @id @default(uuid())
  requestId String   @unique
  teacherId String
  startAt   DateTime
  endAt     DateTime
  createdAt DateTime @default(now())

  request StudentBookingRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  teacher Teacher               @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@unique([teacherId, startAt, endAt])
  @@index([teacherId, startAt])
}

model CoursePackage {
  id        String        @id @default(uuid())
  studentId String
  courseId  String
  type      PackageType
  status    PackageStatus @default(ACTIVE)

  // HOURS 用：按分钟
  totalMinutes     Int?
  remainingMinutes Int?

  // MONTHLY 用：有效期
  validFrom DateTime
  validTo   DateTime?

  paid       Boolean   @default(false)
  paidAt     DateTime?
  paidAmount Int?
  paidNote   String?
  note       String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  student        Student                      @relation(fields: [studentId], references: [id])
  course         Course                       @relation(fields: [courseId], references: [id])
  txns           PackageTxn[]
  attendances    Attendance[]
  sharedStudents CoursePackageSharedStudent[]
  settlements    PartnerSettlement[]

  @@index([studentId, courseId])
  @@index([studentId, courseId, status, validFrom, validTo])
  @@index([courseId, status, validFrom, validTo])
}

model CoursePackageSharedStudent {
  id        String   @id @default(uuid())
  packageId String
  studentId String
  createdAt DateTime @default(now())

  package CoursePackage @relation(fields: [packageId], references: [id], onDelete: Cascade)
  student Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([packageId, studentId])
  @@index([studentId])
}

model PackageTxn {
  id           String   @id @default(uuid())
  packageId    String
  kind         String // PURCHASE / DEDUCT / ROLLBACK / ADJUST
  deltaMinutes Int
  sessionId    String?
  note         String?
  createdAt    DateTime @default(now())

  package CoursePackage @relation(fields: [packageId], references: [id])

  @@index([packageId, createdAt])
  @@index([kind, createdAt])
  @@index([sessionId])
}

model Attendance {
  id        String           @id @default(uuid())
  sessionId String
  studentId String
  status    AttendanceStatus @default(UNMARKED)

  deductedCount   Int @default(0)
  deductedMinutes Int @default(0)

  packageId     String?
  note          String?
  excusedCharge Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  session Session        @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  student Student        @relation(fields: [studentId], references: [id], onDelete: Cascade)
  package CoursePackage? @relation(fields: [packageId], references: [id])

  @@unique([sessionId, studentId])
  @@index([studentId])
}
